<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>3-Token Tic Tac Toe</title>
<style>
    body {
        background: #101010;
        color: white;
        font-family: Arial;
        text-align: center;
        padding-top: 40px;
    }
    #board {
        width: 300px;
        margin: auto;
        display: grid;
        grid-template-columns: repeat(3, 100px);
        gap: 5px;
    }
    .cell {
        width: 100px;
        height: 100px;
        background: #1e1e1e;
        border-radius: 15px;
        font-size: 60px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        transition: 0.2s;
    }
    .fading {
        opacity: 0.4;
    }

    /* Popup */
    #popup {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.8);
        display: none;
        justify-content: center;
        align-items: center;
    }
    #popupBox {
        background: #222;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        width: 250px;
    }
    button {
        margin: 10px;
        padding: 10px 20px;
        background: #444;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
    }
</style>
</head>
<body>

<h1>3-Token Tic Tac Toe</h1>
<h3 id="score">You 0 — 0 AI</h3>

<div id="board"></div>

<div id="popup">
    <div id="popupBox">
        <h2 id="resultText"></h2>
        <button onclick="restartGame()">Play Again</button>
        <button onclick="resetAll()">Reset Score</button>
    </div>
</div>

<script>
let board = ["","","","","","","","",""];
let player = "X";
let ai = "O";

let playerMoves = [];
let aiMoves = [];

let scorePlayer = 0, scoreAI = 0;

const winPatterns = [
    [0,1,2],[3,4,5],[6,7,8],
    [0,3,6],[1,4,7],[2,5,8],
    [0,4,8],[2,4,6]
];

function createBoard() {
    const b = document.getElementById("board");
    b.innerHTML = "";
    for (let i=0; i<9; i++) {
        const cell = document.createElement("div");
        cell.classList.add("cell");
        cell.dataset.index = i;
        cell.onclick = () => playerClick(i);
        b.appendChild(cell);
    }
    updateUI();
}
createBoard();

function updateUI() {
    const cells = document.querySelectorAll(".cell");
    cells.forEach((c,i)=>{
        c.textContent = board[i];
        c.classList.remove("fading");

        // Make next-to-disappear move transparent
        if (playerMoves[0] === i && playerMoves.length === 3) {
            c.classList.add("fading");
        }
        if (aiMoves[0] === i && aiMoves.length === 3) {
            c.classList.add("fading");
        }
    });
}

function playerClick(i) {
    if (board[i] !== "") {
        // Allow clicking faded piece to recycle it
        if (playerMoves[0] === i) {
            placePlayer(i, true);
        }
        return;
    }
    placePlayer(i, false);
}

function placePlayer(i, recycled) {
    if (!recycled) {
        board[i] = player;
        playerMoves.push(i);
    } else {
        // Recycle oldest
        let old = playerMoves.shift();
        board[old] = "";
        board[i] = player;
        playerMoves.push(i);
    }

    if (playerMoves.length > 3) {
        let old = playerMoves.shift();
        board[old] = "";
    }

    updateUI();
    if (checkWin(player)) return endGame("You Win!");
    if (isDraw()) return endGame("Draw!");

    setTimeout(aiMove, 300);
}

function aiMove() {
    let best = bestMove();
    let i = best;

    // Recycle AI transparent piece if clicking same faded cell
    if (board[i] !== "" && aiMoves[0] === i) {
        placeAI(i, true);
        return;
    }

    placeAI(i, false);
}

function placeAI(i, recycled) {
    if (!recycled) {
        board[i] = ai;
        aiMoves.push(i);
    } else {
        let old = aiMoves.shift();
        board[old] = "";
        board[i] = ai;
        aiMoves.push(i);
    }

    if (aiMoves.length > 3) {
        let old = aiMoves.shift();
        board[old] = "";
    }

    updateUI();
    if (checkWin(ai)) return endGame("AI Wins!");
    if (isDraw()) return endGame("Draw!");
}

function checkWin(symbol) {
    return winPatterns.some(p => 
        p.every(i => board[i] === symbol)
    );
}

function isDraw() {
    return board.every(c => c !== "");
}

function bestMove() {
    // Simple AI: choose any empty, or replace its fading
    // (can replace with minimax later)
    for (let i=0; i<9; i++) {
        if (board[i] === "") return i;
    }
    return aiMoves[0]; // fallback
}

// ---------------- Popup ----------------
function endGame(text) {
    if (text === "You Win!") scorePlayer++;
    if (text === "AI Wins!") scoreAI++;

    document.getElementById("score").textContent =
        `You ${scorePlayer} — ${scoreAI} AI`;

    document.getElementById("resultText").textContent = text;
    document.getElementById("popup").style.display = "flex";
}

function restartGame() {
    board = ["","","","","","","","",""];
    playerMoves = [];
    aiMoves = [];
    document.getElementById("popup").style.display = "none";
    createBoard();
}

function resetAll() {
    scorePlayer = 0;
    scoreAI = 0;
    restartGame();
    document.getElementById("score").textContent = "You 0 — 0 AI";
}
</script>

</body>
</html>
